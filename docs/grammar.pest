program    = { SOI ~ expression* ~ EOI }

expression = { modulo | assignment }
assignment = { function ~ "=" ~ block }
block      = { expression | ( "[" ~ expression ~ expression+ ~ "]" ) }

modulo     = { sum ~ ( "%" ~ sum )* }
sum        = { product ~ ( SIGN ~ product )* }
product    = { power ~ ( ( PRODUCT ) ~ power )* }
power      = { primary ~ ( "^" ~ primary )* }

primary    = { number | "(" ~ expression ~ ")" }
call       = { identifier ~ ( "(" ~ arguments ~ ")" )? }
number     = { (SIGN? ~ decimal) | radix }

arguments  = { expression ~ ( "," ~ expression )* }
parameters = { pattern ~ ( "," ~ pattern )* }

pattern    = { function | range | identity }
function   = { name ~ ( "(" ~ parameters ~ ")" )? }
range      = { ( expression ~ LESSER )? ~ name ~ ( GREATER ~ expression )? }
identity   = { expression | ( name ~ EQUALITY ~ expression ) | ( expression ~ EQUALITY ~ name ) }

name       = { "_" | identifier }
identifier = _{ LETTER ~ ( ( "_" | LETTER | NUMBER )*  ~ ( LETTER | NUMBER ) )? }
radix      = _{ ASCII_DIGIT+ ~ "#" ~ SIGN? ~ base36 }
base36     = _{ ASCII_ALPHANUMERIC+ ~ ( "." ~ ASCII_ALPHANUMERIC* )? | ( "." ~ ASCII_ALPHANUMERIC+ ) }
decimal    = _{ ASCII_DIGIT+ ~ ( "." ~ ASCII_DIGIT* )? | ( "." ~ ASCII_DIGIT+ ) }

WHITESPACE = { SPACE_SEPARATOR | NEWLINE }
SIGN       = _{ "+" | "-" }
PRODUCT    = _{ "*" | "/" }
LESSER     = _{ "<" | "<=" }
GREATER    = _{ ">" | ">=" }
EQUALITY   = _{ "=" | "<>" }
COMMENT    = _{ ";" ~ (!NEWLINE ~ ANY)* ~ NEWLINE }
